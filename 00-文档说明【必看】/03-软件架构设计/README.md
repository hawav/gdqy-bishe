# WeiJun Dial 软件架构设计

WeiJun Dial 将硬件层面的一个旋钮、九个环形按键映射成软件层面的若干个线性轴和实际位置无关的逻辑按键。

这些线性轴和按键具体的设计语义在 [交互设计文档](../02-交互设计/README.md) 中进行讨论，在此按下不表。

本文主要探讨软件层面的架构设计问题，为应用开发者提供必要的信息和参考。

## 按键物理位置到逻辑位置的映射

WeiJun Dial 逻辑上使用大拇指、食指和中指进行按键交互。

而在物理上，WeiJun Dial 存在九个按键，每个按键之间按照相同间隔环形排布。

物理按键和逻辑按键不是固定映射的，因此，需要设计一套算法动态计算按键的逻辑位置。

算法基本上分为几个步骤：

1. 从物理按键（第 x 个按键）映射到角度按键（x° 上的按键）
2. 从按键的角度、当前按住的按键数量、用户握持偏好信息计算最终的逻辑位置

### 物理按键映射角度按键

在这一步，需要将按键板上的按键状态从物理位置映射到角度位置。

举个例子：直接读取按键状态得到 `按键1被按下，按键2被按下`，通过这个步骤得到 `按键在90°被按下，按键在120°被按下`

### 角度按键映射逻辑按键

在这一步，需要结合按键的角度、当前按住的按键数量、用户握持偏好信息计算最终的逻辑位置。

我们来分情况讨论：

当目前仅有一个按键按下时，我们仅能通过按键的角度去查找用户握持偏好，以判断逻辑位置。

例如`按键在120°被按下`，这个角度在旋钮的左上角。  
有的用户习惯大拇指放在左上角，其余四指放在右下角；而有的用户习惯大拇指放在左下角，其余四指放在右上角。  
对于前者，这个位置更可能是大拇指；而对于后者食指是更合适的猜测。

当目前已经有手指按住时，我们可以通过按键的相对角度结合用户握持偏好，计算逻辑位置。

例如在`按键120°已按下`的前提下，`按键0°被按下`，也就是说左上角按键按住的前提下按下了正右方的按键，那么根据人类手掌的形状我们知道这个按键很大概率是食指。

## 多环境设计

WeiJun Dial 允许链式注册多个环境（Context）。

这一功能大大简化了 WeiJun Dial 多层级应用开发难度。当前层级注册的事件，只有在当前层级有效，当进入子层级时，所有交互事件都通知到子层级，父层级不会被子层级事件干扰，而导致执行错误的指令。父层级相当于进入暂时休眠态，只有从子层级退出时，父层级才继续恢复工作。如果你对嵌入式开发有了解，这一行为类似于微控制器的中断机制。

例如实现目录导航功能，进入目录则创建一个新的层级；当返回到上一级目录时，返回到父层级。为每个目录配置一个单独的环境能够确保只有在当前目录下才会触发事件。

再例如实现配置菜单功能，这是一个二维列表，第一维度是不同的配置项，第二维度是这些配置项的可选项。第一维度是一个层级；在进入配置项操作时，又是一个层级。同样的，为每个层级配置一个单独的环境能够确保层级之间逻辑上独立，不需要知晓彼此存在，减小开发者心智负担。

再例如交互式向导，各种向导步骤都需要注册 Dial 的位置变换、按键事件，为每个步骤配置一个单独的环境能够确保事件能够通知到正确的目标。

下文介绍的虚拟运动边界、力反馈公式都是配置在环境内的，在创建环境时提供，运行时允许动态修改。不同环境之间相互独立。

## 虚拟运动边界

虚拟运动边界用于指示虚拟空间中的“墙”，例如在一个横向列表中，当旋钮转到了最左端，已经无法再向左移动了，此时旋钮施加一个抵抗力给用户，指示用户无法继续前进。右端同理。

目前抵抗力的算法是线性的，即是说，抵抗力的强度与用户超出边界的范围成正比。这个比值允许开发者通过指令配置。

为避免发生人身意外，抵抗力是存在软件上限的（目前仅发挥了电机5%左右的扭力性能），这个上限同样允许开发者通过指令配置。

特别对于目前版本的 WeiJun Dial，按键板通过有线连接。所以虚拟运动边界必须把运动范围限制在一圈以内，防止按键板连接线缠绕或扯断。

## 力反馈公式

力反馈，即通过电机扭力模拟机械特性。能够提供多样的扭感体验，为用户带来独特的交互感受。

力反馈公式以当前位置作为输入，力矩作为输出。

开发者可以配置力反馈公式（决定扭感）、卡点数、反馈强度等参数，以定制旋钮的扭感体验。
