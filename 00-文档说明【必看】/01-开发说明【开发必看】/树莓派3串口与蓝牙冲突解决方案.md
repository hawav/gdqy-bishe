# 树莓派3串口与蓝牙冲突解决方案

## 背景

树莓派3（Raspberry Pi 3）内置蓝牙芯片与串口通信存在冲突，影响串口设备的正常使用。以下是问题的详细说明和解决方案。

### 冲突原因
树莓派3有两个硬件 UART：
- **PL011 UART**（`/dev/ttyAMA0`）：功能强大，支持更高波特率和更复杂通信，默认被蓝牙占用。
- **mini-UART**（`/dev/ttyS0`）：功能较弱，受 CPU 频率影响，波特率不稳定，默认用于串口通信。

当蓝牙启用时，蓝牙芯片占用 PL011 UART，导致 `/dev/ttyAMA0` 不可用，串口通信只能使用性能较差的 mini-UART（`/dev/ttyS0`）。这可能导致：
- 串口通信不稳定（如波特率偏差）。
- 驱动能力不足（如 TX 电平弱，波形斜坡）。
- 无法满足高性能串口需求（如与 STM32 通信）。

### 解决方案概述
通过禁用蓝牙，可以释放 PL011 UART（`/dev/ttyAMA0`），使其用于串口通信。禁用蓝牙后，`/dev/ttyAMA0` 提供更稳定的通信性能，适合与外部设备（如微控制器）交互。

## 配置步骤

以下是解决串口与蓝牙冲突的详细步骤。

### 步骤 1：编辑 `/boot/config.txt`
1. 打开配置文件：
   ```bash
   sudo nano /boot/config.txt
   ```
2. 在文件末尾添加：
   ```plaintext
   dtoverlay=disable-bt
   ```
   - `dtoverlay=disable-bt` 禁用蓝牙芯片，将 PL011 UART 映射到 GPIO 14（TX）和 GPIO 15（RX），对应 `/dev/ttyAMA0`。
3. 保存（`Ctrl+O`，回车）并退出（`Ctrl+X`）。

### 步骤 2：禁用蓝牙服务（可选）
为确保蓝牙完全禁用，停止相关服务：
```bash
sudo systemctl disable hciuart
```
- `hciuart` 是蓝牙 UART 服务，禁用后可避免资源占用。

### 步骤 3：重启树莓派
应用配置需要重启：
```bash
sudo reboot
```
- 重启后，`/dev/ttyAMA0` 将可用，蓝牙功能被禁用。

### 步骤 4：验证串口配置
1. 检查串口设备：
   ```bash
   ls -l /dev/ttyAMA0
   ```
   - 预期输出：
     ```
     crw-rw---- 1 root dialout 204, 64 May 7 12:00 /dev/ttyAMA0
     ```
   - 如果不存在，检查 `/boot/config.txt` 是否正确配置。

2. 验证 GPIO 映射：
   ```bash
   sudo raspi-gpio get 14,15
   ```
   - 预期输出：
     ```
     GPIO 14: level=1 fsel=2 alt=5 func=TXD0
     GPIO 15: level=1 fsel=2 alt=5 func=RXD0
     ```
   - `alt=5` 表示 GPIO 14/15 已配置为 PL011 UART。

3. 检查蓝牙状态：
   ```bash
   hciconfig
   ```
   - 如果蓝牙已禁用，通常无输出或显示设备未启用。

### 步骤 5：测试串口通信
配置串口并测试与外部设备（如 STM32）的通信：
1. 设置串口参数（例如 9600 波特率，8N1）：
   ```bash
   sudo stty -F /dev/ttyAMA0 9600 cs8 -cstopb -parenb
   ```
2. 接收数据：
   ```bash
   sudo cat /dev/ttyAMA0 | hexdump -ve '/1 "%02X\n"'
   ```
   - 如果外部设备发送 `0x55` 和 `0xAA`，预期输出：
     ```
     55
     AA
     55
     AA
     ...
     ```
3. 发送数据（示例 Python 脚本）：
   ```python
   import serial
   import time

   ser = serial.Serial('/dev/ttyAMA0', 9600, timeout=1)
   try:
       print("每秒交替发送 0x55 和 0xAA")
       while True:
           ser.write(b'\x55')
           print("发送: 0x55")
           time.sleep(1)
           ser.write(b'\xAA')
           print("发送: 0xAA")
           time.sleep(1)
   except KeyboardInterrupt:
       print("停止发送")
   finally:
       ser.close()
   ```
   - 保存为 `send_55_aa.py`，运行：
     ```bash
     sudo python3 send_55_aa.py
     ```

## 注意事项

### 权限管理
- 串口设备需要 `dialout` 组权限：
  ```bash
  sudo usermod -a -G dialout $USER
  ```
  - 注销后重新登录生效。
- 临时授予权限：
  ```bash
  sudo chmod 666 /dev/ttyAMA0
  ```

### 蓝牙禁用影响
- 禁用蓝牙后，内置蓝牙不可用，可能影响蓝牙相关应用。
- 替代方案：使用 USB 蓝牙适配器，插入树莓派 USB 端口并配置。

### 硬件连接
- **树莓派到外部设备（如 STM32）**：
  - GPIO 14（TX，`/dev/ttyAMA0`） → 外部设备 RX。
  - GPIO .Concurrent Assistant 15（RX，`/dev/ttyAMA0`） → 外部设备 TX。
  - GND 共地。
- 电平：树莓派和 STM32 均为 3.3V TTL，无需电平转换器。
- 线路：使用短线（<30cm），避免寄生电容导致波形斜坡。

### 恢复蓝牙
- 删除 `/boot/config.txt` 中的 `dtoverlay=disable-bt` 行：
  ```bash
  sudo nano /boot/config.txt
  ```
- 重启：
  ```bash
  sudo reboot
  ```
- 重新启用蓝牙服务：
  ```bash
  sudo systemctl enable hciuart
  ```

### mini-UART 的局限性
- 如果不禁用蓝牙，串口通信将使用 `/dev/ttyS0`（mini-UART），其局限性包括：
  - 波特率受 CPU 频率影响，可能不稳定。
  - 驱动能力弱，可能导致 TX 电平不足或波形斜坡。
  - 无断点检测、帧错误检测等高级功能。
- 建议始终使用 `/dev/ttyAMA0`（PL011 UART）以获得最佳性能。

## 常见问题解答

| 问题 | 解答 |
|------|------|
| 禁用蓝牙后，串口仍不可用？ | 检查 `/boot/config.txt` 是否正确添加 `dtoverlay=disable-bt`，确认重启后 `/dev/ttyAMA0` 存在。运行 `sudo raspi-gpio get 14,15` 验证 GPIO 功能。 |
| 如何确认蓝牙已禁用？ | 运行 `hciconfig`，无输出或显示设备未启用表示成功。 |
| 禁用蓝牙后还能使用蓝牙吗？ | 内置蓝牙不可用，可使用 USB 蓝牙适配器。 |
| 串口通信不稳定？ | 确保波特率匹配（例如 9600），检查线路长度和接地。用示波器验证 TX/RX 波形。 |
| 需要其他配置吗？ | 确保禁用串口控制台（默认已禁用）。运行 `sudo raspi-config`，选择“Interface Options” → “Serial Port” → 禁用登录 shell。 |

## 示例应用：与 STM32 通信

以下是一个完整的示例，展示树莓派与 STM32 的串口通信。

### 树莓派发送数据
```python
import serial
import time

ser = serial.Serial('/dev/ttyAMA0', 9600, timeout=1)
try:
    print("每秒交替发送 0x55 和 0xAA")
    while True:
        ser.write(b'\x55')
        print("发送: 0x55")
        time.sleep(1)
        ser.write(b'\xAA')
        print("发送: 0xAA")
        time.sleep(1)
except KeyboardInterrupt:
    print("停止发送")
finally:
    ser.close()
```

### 树莓派接收数据
```bash
sudo stty -F /dev/ttyAMA0 9600 cs8 -cstopb -parenb
sudo cat /dev/ttyAMA0 | hexdump -ve '/1 "%02X\n"'
```

### STM32 接收代码（Rust 示例）
```rust
use embedded_hal::serial::Read;

let mut u1 = dp
    .USART1
    .serial::<u8>(
        (pa.pa9, pb.pb7),
        uart::Config::default()
            .baudrate(9600.bps())
            .wordlength_8()
            .parity_none()
            .stopbits(uart::config::StopBits::STOP1),
        &clocks,
    )
    .unwrap();

loop {
    if let Ok(byte) = u1.read() {
        // 调试输出，例如通过另一个 UART
        // println!("Received: 0x{:02X}", byte);
    }
}
```

### 硬件连接
| 树莓派引脚 | STM32 引脚 | 功能 |
|------------|------------|------|
| GPIO 14    | PB7 (RX)   | TX   |
| GPIO 15    | PA9 (TX)   | RX   |
| GND        | GND        | 共地 |

## 故障排除

- **串口设备不存在**：
  - 确认 `/boot/config.txt` 中有 `dtoverlay=disable-bt`。
  - 检查 `/dev/ttyAMA0` 是否存在：
    ```bash
    ls /dev/ttyAMA0
    ```
  - 如果不存在，检查是否正确重启。

- **波形斜坡或电平弱**：
  - 使用 PL011 UART（`/dev/ttyAMA0`）通常比 mini-UART 更稳定。
  - 检查 TX 引脚（GPIO 14）电压，用示波器验证波形。
  - 添加 4.7kΩ 上拉电阻（GPIO 14 到 3.3V）或使用 74HC125 缓冲器。

- **接收数据错误**：
  - 确保树莓派和外部设备波特率一致（例如 9600）。
  - 检查线路长度（<30cm），确保接地可靠。
  - 测试更低波特率（如 4800）以减少电平问题影响。

- **蓝牙仍占用串口**：
  - 确认蓝牙服务已禁用：
    ```bash
    sudo systemctl status hciuart
    ```
  - 如果仍在运行，强制禁用：
    ```bash
    sudo systemctl stop hciuart
    sudo systemctl disable hciuart
    ```

## 参考资料
- [Raspberry Pi Forums: Bluetooth Serial Port Setup](https://forums.raspberrypi.com/viewtopic.php?t=154651)
- [eLinux.org: Raspberry Pi Serial Connection](https://elinux.org/RPi_Serial_Connection)
- [GitHub: BLE-UART Conflict on Raspberry Pi 3](https://github.com/nebrius/raspi-serial/issues/3)